import OpenAI from "openai";
import type { Product } from "./scrape.js";

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function analyzeProduct(product: Product, websiteContent?: string) {
  const feedPostContext = product.firstFeedPost ? `\n\n[첫 번째 피드 글]\n${product.firstFeedPost}` : "";
  const websiteContext = websiteContent ? `\n\n[웹사이트 정보]\n${websiteContent}` : "";

  const prompt = `
너는 시니어 프론트엔드 개발자이자 제품 기획 CPO(Product Owner)야.
다음은 Indie Hackers의 제품 정보와 실제 웹사이트를 분석한 내용이야:

이름: ${product.name}
설명: ${product.description}
월 매출: $${product.revenue}/month
첫번째 피드: ${feedPostContext}
프로덕트 웹사이트 정보: ${websiteContext}

위 정보를 종합하여 다음 항목들을 상세하게 분석해줘:

## 1️⃣ 핵심 가치 제안 (Core Value Proposition)

### 이 제품이 해결하는 핵심 문제는 무엇인가?
[핵심 문제에 대한 명확한 설명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 위에서 제공된 정보(제품 설명, 웹사이트 정보, 첫 번째 피드 등) 중 어떤 부분을 바탕으로 이 문제를 도출했는지 구체적으로 명시

### 타겟 고객은 누구인가?
[타겟 고객에 대한 명확한 설명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 웹사이트 정보, 제품 설명, 매출 규모 등을 통해 타겟 고객을 추론한 근거를 제시

### 제품의 독특한 포지셔닝은 무엇인가?
[제품의 독특한 포지셔닝에 대한 명확한 설명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 웹사이트의 메인 설명, 주요 기능, 가격 정책 등을 바탕으로 포지셔닝을 분석한 근거를 명시

## 2️⃣ 벤치마킹 가치 평가 (ROI 중심)

**평가 기준**: 
- 내가 들이는 공수(개발 시간, 기술 난이도, 비용) 대비 얻을 수 있는 경제적 가치(매출 잠재력)가 큰가?
- 큰 힘듦 없이 만들 수 있는데 매출을 발생시키기 적합한가? (낮은 개발 난이도 + 높은 수익 잠재력)
- 시장 규모와 잠재 수요가 충분한가? (마케터 관점에서 검증: 타겟 시장 규모, 잠재 고객 수, 수요 증가 추세 등)

### 벤치마킹 가치: ✅/❌
[벤치마킹 가치 평가 결과를 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성. 공수 대비 경제적 가치 분석, "큰 힘듦 없이 매출 발생시키기 적합한/적합하지 않은" 이유, 시장 규모 및 잠재 수요 분석, 구체적인 ROI 근거를 종합하여 작성]
- 🔎 근거:제품의 현재 매출, 기술 스택 복잡도, 개발 예상 시간, 시장 규모, 잠재 수요 등을 종합하여 ROI가 높다고 판단한 구체적 근거를 명시

## 3️⃣ 기술 스택 및 아키텍처 예측

**중요**: 실제 웹사이트를 Wappalyzer나 크롬 개발자 도구로 분석했을 때 확인할 수 있는 기술 스택 정보를 바탕으로 분석해야 합니다. 
- HTML 소스 코드, JavaScript 파일명, 메타 태그, 네트워크 요청, CDN 사용 여부 등을 통해 실제로 사용 중인 기술을 파악해야 합니다.
- 추측이 아닌, 실제로 확인 가능한 코드 패턴이나 라이브러리 사용 흔적을 근거로 제시해야 합니다.

### 예상 프론트엔드 스택 (Next.js, React, Vue 등)
[예상되는 프론트엔드 스택 기술명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: HTML 소스에서 확인된 프레임워크 특징(예: __NEXT_DATA__ 변수, React 컴포넌트 패턴, Vue.js 특징 등), JavaScript 번들 파일명, 메타 태그, 또는 웹사이트의 실제 동작 방식에서 확인할 수 있는 기술 스택을 구체적으로 명시

### 예상 백엔드/인프라 (Supabase, AWS, Vercel 등)
[예상되는 백엔드/인프라 기술명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 네트워크 요청, API 엔드포인트, 서버 헤더 정보, CDN 사용 여부, 또는 웹사이트 소스에서 확인된 실제 인프라 사용 흔적을 구체적으로 명시

### 예상 데이터베이스 및 저장소
[예상되는 데이터베이스 및 저장소 기술명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: API 응답 패턴, 데이터 구조, 또는 실제 확인 가능한 데이터베이스 사용 흔적을 구체적으로 명시

### 예상 결제 시스템 (Stripe, Paddle 등)
[예상되는 결제 시스템 기술명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 웹사이트에서 실제로 확인된 결제 관련 스크립트, API 호출, 또는 결제 버튼/폼에서 확인할 수 있는 결제 시스템 사용 흔적을 구체적으로 명시

### 예상 주요 라이브러리/도구
[예상되는 주요 라이브러리/도구명을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: JavaScript 파일명, 라이브러리 import 패턴, 또는 실제로 확인된 라이브러리 사용 흔적을 구체적으로 명시

## 4️⃣ 개발 시간 및 난이도 추정

### 비슷한 서비스를 만드는데 예상 소요 시간 (주 단위)
[예상 소요 시간을 주 단위로 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 제품의 기능 복잡도, 기술 스택 난이도 등을 바탕으로 추정한 근거

### 기술적 난이도 (초급/중급/고급)
[기술적 난이도(초급/중급/고급)를 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 필요한 기술 스택, 아키텍처 복잡도 등을 바탕으로 판단한 근거

### 주요 개발 단계별 시간 배분 (프로토타입, MVP, 완성 버전)
[각 단계별 예상 시간 배분을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 제품의 기능 우선순위와 복잡도를 바탕으로 배분한 근거

### 예상 장애물 및 해결 방법
[예상되는 주요 장애물과 해결 방법을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 제품의 기술적/비즈니스적 특성을 바탕으로 예상한 근거

## 5️⃣ 비즈니스 모델 분석

### 수익 모델 (구독, 일회성 결제, 프리미엄 등)
[예상되는 수익 모델을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 웹사이트의 가격 정보, 제품 특성, 매출 규모 등을 바탕으로 추론한 근거

### 예상 가격 정책
[예상되는 가격 정책을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 웹사이트의 가격 정보, 경쟁사, 타겟 고객 등을 바탕으로 분석한 근거

### 마케팅 전략 힌트
[제안하는 마케팅 전략을 바로 작성 - 불릿 포인트 없이 바로 본문으로 작성]
- 🔎 근거: 제품의 포지셔닝, 타겟 고객, 가격 정책 등을 바탕으로 제안한 근거

**중요**: 
- 각 메인 섹션은 반드시 ## 헤딩(h2) 형식으로 작성해야 합니다 (예: ## 1️⃣ 핵심 가치 제안).
- 각 질문 항목은 반드시 ### 헤딩(h3) 형식으로 작성해야 합니다 (예: ### 이 제품이 해결하는 핵심 문제는 무엇인가?).
- 모든 질문 제목 앞에는 반드시 ### (공백 1개)을 붙여서 마크다운 헤더 형식으로 작성해야 합니다.
- 각 분석 항목마다 먼저 결론을 불릿 포인트 없이 바로 본문으로 작성하고("결론:" 같은 필드 이름 없이), 그 다음에 "- 🔎 근거:" 다음에 **빈 줄 없이 바로** 하위 불릿 포인트(들여쓰기 4칸)로 근거 내용을 작성해야 합니다. 마크다운에서 하위 불릿 포인트가 제대로 작동하려면 빈 줄이 있으면 안 됩니다.
- 결론은 해당 항목에 대한 명확하고 간결한 답변을 포함해야 합니다.
- 근거는 위에서 제공된 정보(제품 설명, 웹사이트 정보, 첫 번째 피드, 매출 등)를 구체적으로 언급하며 설명해야 합니다. 
- 추측이나 일반론이 아닌, 제공된 정보를 바탕으로 한 객관적인 분석 근거를 제시해주세요.
- 특히 벤치마킹 가치 평가는 ✅/❌ 결과에 상관없이 "✅인 경우:" 또는 "❌인 경우:" 같은 블록을 만들지 말고, 바로 결론과 근거를 작성해야 합니다.
- 벤치마킹 가치 평가는 반드시 ROI(공수 대비 경제적 가치)와 시장 규모/잠재 수요(마케터 관점)를 중심으로 평가해야 합니다.

각 항목을 명확하게 구분하고, 구체적이고 실용적인 정보를 제공해줘.
한국어로 작성하고, 개발자가 실제로 활용할 수 있는 수준의 상세함을 유지해줘.
`;

  const res = await client.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [{ role: "user", content: prompt }],
    temperature: 0.7,
  });

  return res.choices[0].message.content?.trim() || "";
}

export async function translateDescription(product: Product): Promise<string> {
  const prompt = `
다음 영어 제품 설명을 자연스러운 한국어로 번역해줘:

${product.description}

번역 시 주의사항:
- 전문 용어는 적절히 한국어로 번역하되, 널리 알려진 경우 영어 그대로 사용 가능
- 자연스럽고 읽기 쉬운 한국어로 번역
- 제품의 의미를 정확히 전달
`;

  const res = await client.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [{ role: "user", content: prompt }],
    temperature: 0.3,
  });

  return res.choices[0].message.content?.trim() || product.description;
}
